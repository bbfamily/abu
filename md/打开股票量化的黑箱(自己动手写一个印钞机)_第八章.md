# æ‰“å¼€è‚¡ç¥¨é‡åŒ–çš„é»‘ç®±(è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº) ç¬¬å…«ç« 

### ä½œè€…ï¼šé˜¿å¸ƒğŸ¶

### æœªç»æœ¬äººå…è®¸ç¦æ­¢è½¬è½½

_____

##  éå‡è¡¡èƒœè´Ÿæ”¶ç›Šå¸¦æ¥çš„å¿…ç„¶éå‡è¡¡èƒœè´Ÿæ¯”ä¾‹ï¼Œç›®æ ‡ç”±å› å­çš„èƒ½åŠ›è§£å†³ä¸€éƒ¨åˆ†ï¼Œæ¨¡å¼è¯†åˆ«æå‡å…³é”®çš„ä¸€éƒ¨åˆ†

___
ä¸Šä¸€ç« æ„å»ºå®Œæ‰€æœ‰çš„è£åˆ¤ï¼Œå¹¶ä¸”é€šè¿‡å¯è§†åŒ–é€‰æ‹©äº†è£åˆ¤çš„å‚æ•°ï¼Œé€šè¿‡æ•°æ®ç»Ÿè®¡æ„å»ºäº†æ‹¦æˆªè§„åˆ™, æ‹¦æˆªè§„åˆ™é€šè¿‡UmpPipeLineClassèåˆåœ¨ä¸€èµ·å½¢æˆæ‹¦æˆªè§„åˆ™ï¼Œè¿™é‡Œä¸åšè¿‡å¤šä»£ç è®²è§£ï¼Œæœ€åä¸€ç« äº†ï¼Œè½»æ¾ç‚¹å§ï¼Œæœ‰å…´è¶£å¯ä»¥æŸ¥çœ‹æºä»£ç UmpPipeLine.py

è¿™ä¸€ç« çš„å·¥ä½œï¼Œä½¿ç”¨11å¹´åè‡³ä»Šå­¦ä¹ çš„æ•°æ®ä½œç”¨åœ¨10å¹´çš„å›æµ‹ä¸æ²¡æœ‰ä½œç”¨çš„è¿›è¡Œå¯¹æ¯”

* run_factor_by_yearç”Ÿæˆ10å¹´çš„å›æµ‹ç»“æœé›†
* run_funcï¼šå›æµ‹ä¸å¼€å¯è¯†åˆ«ä¼˜åŒ–
* run_func_with_filterï¼šå›æµ‹å¼€å¯è¯†åˆ«ä¼˜åŒ–
* run_func_with_mlï¼šå›æµ‹å¼€å¯è¯†åˆ«ä½†åªåšæ•°æ®è®°å½•æ„æˆç»Ÿè®¡æ•°æ®ä¸åšäº¤æ˜“æ‹¦æˆª





	import FactorUnitTest
	import BuyGoldenFactor
	import SymbolPd
	from BuyGoldenFactor import BuyGoldenFactorClass

	def run_factor_by_year(enable_fiter, enable_filter_ml, enable_snap, enable_filter_pipe_ml, symbols=None):
	    SymbolPd.g_force_folds = 7
	    SymbolPd.g_force_n_year = 1
	    
	    BuyGoldenFactor.g_enable_fiter = enable_fiter
	    
	    BuyGoldenFactor.g_enable_filter_ml = enable_filter_ml
	    BuyGoldenFactor.g_enable_snap = enable_snap
	    BuyGoldenFactor.g_enable_filter_pipe_ml = enable_filter_pipe_ml
	    
	    buy_factors = [{'XD': 42, 'class': BuyGoldenFactorClass, 'draw': True}]
	    sell_factors = []
	    parameters = {
	        'stop_win_base_n': 4.5,
	        'stop_loss_base_n': 2.0,
	        'mv_close_atr': 3.5,
	        'mv_pre_atr': 2.0,
	    }
	    if symbols is None:
	        cap, results, orders_pd, action_pd, all_fit_symbols = FactorUnitTest.random_unit_test(ret_cnt_need=0, 
	                buy_factors=buy_factors, sell_factors=sell_factors, parameters=parameters, show=False)
	    else:
	        cap, results, orders_pd, action_pd, all_fit_symbols = FactorUnitTest.random_unit_test(ret_cnt_need=0, 
	                symbols=symbols,
	                buy_factors=buy_factors, sell_factors=sell_factors, parameters=parameters, show=False)
	    return cap, results, orders_pd, action_pd, all_fit_symbols

	from functools import partial
	run_func = partial(run_factor_by_year, False, False, False, False)
	run_func_with_filter = partial(run_factor_by_year, True, False, False, False)
	run_func_with_ml = partial(run_factor_by_year, True, False, False, True)
	run_func_with_snap = partial(run_factor_by_year, True, False, True, False)


é¦–å…ˆå¯¹2010å¹´ä½¿ç”¨å› å­è¿›è¡Œå›æµ‹ï¼Œçº¯å›æµ‹ï¼Œä¸è®°å½•å­¦ä¹ ç»Ÿè®¡æ•°æ®ï¼Œä¸å¯¹äº¤æ˜“è¿›è¡Œçº æ­£æ‹¦æˆª

	import MetricsManger
	from MetricsManger import metrics_rsc
	from FactorMetrics import METRICSTYPE
	from UmpMain import UmpMainClass
	from MlFiterGoldenPd import MlFiterGoldenPdClass
	rsc_ret = run_func()
	rsc = metrics_rsc(*rsc_ret)
	MetricsManger.make_metrics_from_rsc(rsc, METRICSTYPE.SYSMBOL_R_SCORES_GOLDEN.value, show=False)
	UmpMainClass(rsc.ordersPd, MlFiterGoldenPdClass).show_general()
		# out
		all fit order = (8077, 31)
		win rate = 0.507366596509
		profit_cg.sum() = 63.1474660094
		win mean = 0.0710351737508 loss_mean = -0.0575207358116 



![output_7_1.png](http://upload-images.jianshu.io/upload_images/3136804-e178980c6f9c223d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç„¶åå¯¹2010å¹´ä½¿ç”¨å› å­è¿›è¡Œå›æµ‹å¹¶ä¸”è¿›è¡Œçº æ­£æ‹¦æˆª


	rsc_filter_ret = run_func_with_filter()
	rsc_filter = metrics_rsc(*rsc_filter_ret)
	MetricsManger.make_metrics_from_rsc(rsc_filter, METRICSTYPE.SYSMBOL_R_SCORES_GOLDEN.value, show=False)
	UmpMainClass(rsc_filter.ordersPd, MlFiterGoldenPdClass).show_general()
		# out
		all fit order = (7732, 31)
		win rate = 0.518734609415
		profit_cg.sum() = 66.8634043939
		win mean = 0.0695253920443 loss_mean = -0.0553854481924 




![output_9_1.png](http://upload-images.jianshu.io/upload_images/3136804-95f18c7c171cc99f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


    rsc.ordersPd.shape[0] - rsc_filter.ordersPd.shape[0]
        # out
        403

å·²ç»æœ‰ç»“æœçš„ç»Ÿè®¡æ•°æ®

    8077 - 7732, 0.518734609415 - 0.507366596509, 66.8634043939 - 63.1474660094
        # out
       (345, 0.011368012906000091, 3.7159383844999994)


## å¯¹ç»“æœæ»¡æ„å—ï¼Ÿå¯¹345ç¬”äº¤æ˜“è¿›è¡Œæ‹¦æˆªï¼Œèƒœç‡æå‡äº†0.011ï¼Œè¿˜ä¸é”™å˜›ï¼Œä½†æ˜¯ä½ çŸ¥é“å®é™…ç»“æœå¯èƒ½ä¼šæ›´å¥½å—ï¼Œä½ å‘ç°2010å¹´æœ€åçš„è¿™å‡ ä¸ªæœˆæ˜¯ä¸‹è¡Œé˜¶æ®µå—ï¼Ÿä½ å‘ç°ä¸€å…±æ‹¦æˆªäº†403ä¸ªå•å­å—ï¼Œä½†æœ‰ç»“æœçš„åªæœ‰345ä¸ªå•å­ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„ç»“æœç»Ÿè®¡æ˜¯é’ˆå¯¹å·²ç»æœ‰ç»“æœçš„å•å­è¿›è¡Œç»Ÿè®¡ï¼Œå¾ˆæœ‰å¯èƒ½æ‹¦æˆªçš„è§„åˆ™åœ¨æœ€åè¿™ä¸€æ®µé›†ä¸­çˆ†å‘ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰è¿›è¡Œæ‹¦æˆªçš„é‚£äº›ç»Ÿè®¡æ•°æ®é‡Œç”±äºæœ€åä»ä¸ºæˆäº¤ï¼Œå¹¶æ²¡æœ‰è®¡ç®—åˆ°èƒœç‡é‡Œï¼Œå¥½ï¼Œæˆ‘ä»¬ä¸‹é¢å°±å°†è¯æ˜è¿™ä¸ªçŒœæƒ³æ˜¯å¦æ­£ç¡®

run_func_with_mlé’ˆå¯¹äº¤æ˜“å­¦ä¹ æ•°æ®åˆ†ç±»ç»“æœ

		rsc_ml_ret = run_func_with_ml()
		rsc_ml = metrics_rsc(*rsc_ml_ret)
		MetricsManger.make_metrics_from_rsc(rsc_ml, METRICSTYPE.SYSMBOL_R_SCORES_GOLDEN.value, show=False)
		order_pd_ml = rsc_ml.ordersPd


è¿™æ ·åªå¯¹äº¤æ˜“åªè¿›è¡Œæ•°æ®å†™å…¥ï¼Œä¸è¿›è¡Œæœ€ç»ˆçš„æ‹¦æˆªï¼Œå› è€Œæ•°æ®åªåŒ…å«äº†å¦‚ä¸‹

    can_win_pd = order_pd_ml.filter(['result', 'can_win', 'edge', 'edge_type'])
    can_win_pd.head()

|  | result | can_win | edge | edge_type |
| --- | --- | --- | --- | --- |
| 2010-11-09 | 0 | 1 | 1 | 8 |
| 2011-03-30 | 0 | 1 | 0 | 8 |
| 2011-07-12 | 0 | 0 | -1 | 0 |
| 2011-07-15 | 0 | 1 | 0 | 8 |
| 2011-07-28 | 0 | 1 | 0 | 8 |

å¯¹ç…§UmpPipeLineClassä¸­learn_pipe_line_predictçš„è¿”å›ç»“æœï¼Œä»crosstabä¸Šçœ‹æ•´ä¸ªç»“æœæ˜¯ç†æƒ³çš„ï¼Œé—®é¢˜åº”è¯¥å‡ºåœ¨edge_type ï¼ 0çš„æœ‰35ä¸ªè¿˜æŒæœ‰çš„å•å­type 0çš„åˆ†ç±»æ˜¯ä¸»è£hitäº†20æ¬¡ä»¥ä¸Šçš„äº¤æ˜“ï¼Œå¯ä»¥è¯´æ˜¯æœ€æœ‰ä¿è¯åº”è¯¥è¢«æ‹¦æˆªçš„

    pd.crosstab([can_win_pd['result'], can_win_pd['can_win']], can_win_pd['edge_type'])


![Snip20161021_51.png](http://upload-images.jianshu.io/upload_images/3136804-866627a3e1e05a4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

	 # è¿™é‡Œè¿˜æ˜¯è´´ä»£ç äº†ï¼Œæœ¬æƒ³æœ€åä¸€ç« è½»æ¾ä¸€ç‚¹ğŸ˜­ï¼Œåªä¸ºé˜è¿°ä¸Šé¢çš„è¡¨æ ¼å¯¹æ‹¦æˆªè¿›è¡Œåˆ†ç±»çš„ä»£ç 0-8ç±»åˆ«
	 class UmpPipeLineClass(object):
	    def __init__(self, ump_dict):
	        self.ump_dict = ump_dict

	        self.main_umps = []
	        self.jump_ump = None
	        self.edge_ump = None
	        for ump, ump_args in self.ump_dict.items():
	            if isinstance(ump, UmpMainClass):
	                self.main_umps.append((ump, ump_args))
	            elif isinstance(ump, UmpJumpClass):
	                self.jump_ump = (ump, ump_args)
	            elif isinstance(ump, UmpEdgeClass):
	                self.edge_ump = (ump, ump_args)
	            else:
	                raise TypeError('what a ump type set!')

	    def do_pipe_line_predict(self, **kwargs):
	        return self.learn_pipe_line_predict(**kwargs)[0]

	    def learn_pipe_line_predict(self, **kwargs):
	        """
	        :param kwargs:
	        :return:
	        """
	        main_hit_cnt = 0
	        for ump, ump_args in self.main_umps:
	            if 'cons' in ump_args:
	                cons_func = ump_args['cons']
	                if not cons_func(kwargs):
	                    """
	                        æ‰§è¡Œé™åˆ¶æ¡ä»¶func, exp
	                        UmpJumpClass(None, MlFiterJumpPdClass, predict=True): {'w_col': MlFiterJumpPd.g_w_col,
	                        'need_ind_cnt': 1, 'cons': lambda order: order['diff_days'] < 21}
	                    """
	                    continue
	            if 'w_col' not in ump_args:
	                raise ValueError('MISS w_col not in ump_args!!!')
	            main_hit_cnt += ump.predict_hit_kwargs(ump_args['w_col'], **kwargs)

	        jump_hit_cnt = 0
	        if self.jump_ump is not None:
	            ump, ump_args = self.jump_ump
	            if 'cons' in ump_args:
	                cons_func = ump_args['cons']
	                if cons_func(kwargs) and 'w_col' in ump_args:
	                    jump_hit_cnt = ump.predict_hit_kwargs(ump_args['w_col'], **kwargs)

	        if self.edge_ump is not None:
	            ump, ump_args = self.edge_ump
	            edge_pred = ump.predict(**kwargs)

	            """
	                æ‰€æœ‰å‚æ•°é€šè¿‡learn_ump_hit_cntï¼Œlearn_ump_predict
	                å­¦ä¹ å¯è§†åŒ–è€Œæ¥ï¼Œå¾®è°ƒä¸è¦å¯¹æ•°æ®è¿‡æ‹Ÿåˆ, ifé€»è¾‘æœ‰é‡å¤å¯ä¼˜åŒ–
	                ä½†ä¸ºå¤–é¢mlæä¾›ç»†çš„ç±»åˆ«æš‚æ—¶ä¸è¦ä¼˜åŒ–
	            """
	            if main_hit_cnt >= 20 and edge_pred <> 1:
	                return 0, edge_pred, 0

	            if jump_hit_cnt >= 5 and edge_pred <> 1:
	                return 0, edge_pred, 1

	            if jump_hit_cnt > 1 and main_hit_cnt > 10:
	                return 0, edge_pred, 2

	            if edge_pred == 1 and (jump_hit_cnt >= 3 and main_hit_cnt >= 6):
	                return 0, edge_pred, 3

	            if edge_pred == 1 and main_hit_cnt >= 25:
	                return 0, edge_pred, 4

	            if edge_pred == 0 and (jump_hit_cnt >= 2 and main_hit_cnt >= 4):
	                return 0, edge_pred, 5

	            if edge_pred == 0 and main_hit_cnt >= 15:
	                return 0, edge_pred, 6

	            if edge_pred == -1 and (main_hit_cnt >= 1 or jump_hit_cnt >= 1):
	                return 0, edge_pred, 7

	            return 1, edge_pred, 8
	        return 1, -1, -1

ä»¥å‘¨æœŸå†…æœ€åä¸€å¤©ä¸ºé™åˆ¶æ—¥ï¼ŒæŸ¥çœ‹è¿™35ä¸ªå•å­çš„ç›ˆäºæƒ…å†µï¼Œç»“æœå–œäººé˜¿ï¼

	from Capital import CapitalClass
	import SymbolPd
	orders_pd_n_ret = order_pd_ml[(order_pd_ml.result == 0) & (order_pd_ml.edge_type == 0)]
	cap = CapitalClass(1000000000)
	def calc_last_loss(order):
	    kl_pd = SymbolPd.make_kfold_pd(order.Symbol, cap=cap)
	    return kl_pd.iloc[-1].close - order['buy Price']

	last_loss_result = orders_pd_n_ret.apply(calc_last_loss, axis=1)
	last_loss_result.sum()
	dummies_result = pd.Series(np.where(last_loss_result > 0, 1, 0))
	float(dummies_result.value_counts()[0])/dummies_result.value_counts().sum()
        # out
        0.6571428571428571
___

    dummies_result.value_counts()[0], dummies_result.value_counts()[1]
        # out
        (23, 12)

ç»“æœæ˜¾ç¤ºæœ€åè¿™æ‰¹äº¤æ˜“åªæœ‰35%æ˜¯ç›ˆåˆ©çš„ï¼Œè¿™æ ·çœ‹æ¥æœ€ç»ˆçš„èƒœç‡è¿˜èƒ½æœ‰æ‰€æå‡çš„

____

____


è¿™ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±ç®—æ˜¯ä¸ªå®Œç»“äº†ï¼Œè¿™ç¯‡æ–‡ç« çš„ä¸­å¿ƒå†æ¬¡é‡ç”³

##  éå‡è¡¡èƒœè´Ÿæ”¶ç›Šå¸¦æ¥çš„å¿…ç„¶éå‡è¡¡èƒœè´Ÿæ¯”ä¾‹ï¼Œç›®æ ‡ç”±å› å­çš„èƒ½åŠ›è§£å†³ä¸€éƒ¨åˆ†ï¼Œæ¨¡å¼è¯†åˆ«æå‡å…³é”®çš„ä¸€éƒ¨åˆ† 

æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯
![Snip20161021_50.png](http://upload-images.jianshu.io/upload_images/3136804-ba62d73acf9b2bb0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

 



### ä¹Ÿè®¸ä½ çœ‹åˆ°æœ€åå‘ç°ä¸€å…±èƒœç‡åªæé«˜1ä¸ªå¤šç‚¹ï¼Œæ€ä¹ˆæ¨¡å¼è¯†åˆ«å°±æˆä¸ºå…³é”®ç¯èŠ‚äº†ï¼Œå› ä¸ºé’ˆå¯¹å› å­çš„èƒ½åŠ›å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯éœ€è¦ä¾é å¤§ç›˜çš„èµ°åŠ¿çš„ï¼ˆåœ¨ä¸è€ƒè™‘åšç©ºçš„å‰æä¸‹ï¼‰ï¼Œç„¶è€Œæ¨¡å¼è¯†åˆ«è¿™éƒ¨åˆ†èƒ½åŠ›ä¸è®ºå¤§ç›˜å¥½åå®ƒéƒ½è¦å‘æŒ¥åŠŸç”¨ï¼Œå°±åƒè¿™é‡Œæœ€åä»‹ç»çš„è¿™ä¸ªå®ä¾‹ï¼Œå¤§ç›˜ä¸å¥½çš„æ—¶å€™æ¨¡å¼è¯†åˆ«æ‹¦æˆªäº†æ›´å¤šçš„äº¤æ˜“ï¼Œæ›´ä½•å†µä½ å¯ä»¥é€šè¿‡å„ç§æ‰‹æ®µå»ä¼˜åŒ–è¿™éƒ¨åˆ†èƒ½åŠ›ï¼Œæ¯”å¦‚æˆ‘çš„ç³»ç»Ÿä¸­çš„è£åˆ¤æœºåˆ¶ï¼Œè¿™é‡Œè¿™ä¸ªåªæ˜¯ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œå®é™…ä¸Šçš„è£å†³ç³»ç»Ÿä¹Ÿè®¸ä¸»è£å°±æœ‰æ•°åä¸ªï¼Œè¾…åŠ©è£åˆ¤ä¹Ÿä¼šæœ‰å¾ˆå¤šï¼Œå®ƒä»¬ä¼šåˆ©ç”¨æ›´åˆç†çš„ç»„åˆæ–¹æ¡ˆç»„æˆ pipelineæ¥æå‡æ•ˆæœï¼Œä½†æ˜¯å°é’æœºè¿˜æœ‰å¾ˆå¤šå¤æ‚çš„ç»„ä»¶ï¼Œå›æµ‹ç³»ç»Ÿï¼Œäº¤æ˜“ç³»ç»Ÿï¼Œé£é™©æ§åˆ¶ç³»ç»Ÿï¼Œå› å­ä¼˜åŒ–ç³»ç»Ÿï¼Œè¿˜æœ‰å®ç›˜ç³»ç»Ÿ, æ¯ä¸€ä¸ªç¯èŠ‚ä¸å‡†è®¸æœ‰ä¸€ç‚¹å·®æ± ï¼Œåœ¨ä½ çš„æ„è¯†é‡Œè¦æ¥è¿‘å®Œç¾çš„å»å†™æ¯ä¸€è¡Œä»£ç ï¼Œå»æ£€æµ‹æ¯ä¸€è¡Œä»£ç ï¼Œå°±ç®—è¿™æ ·ï¼Œä¹Ÿè®¸æœ‰ä¸€å¤©ä½ ä»ç„¶ä¼šå‘ç°æŸä¸ªç¯èŠ‚æœ‰ä¸ªbugä¸€ç›´æ²¡æœ‰å‘ç°ï¼Œå¯¼è‡´ä½ å¯¹æ•´ä¸ªç³»ç»Ÿçš„ä¿¡å¿ƒä¸‹é™ï¼Œä½†ä½ ä¸èƒ½æ”¾å¼ƒï¼Œå› ä¸ºè¿™æ˜¯ä½ è‡ªå·±é€‰æ‹©çš„é“è·¯ï¼Œè·ªç€ä¹Ÿèµ°å®Œå®ƒå§ï¼

## æœ€åé€ä¸Šæµ·é¾Ÿäº¤æ˜“æ³•åˆ™ä¸­æˆ‘æœ€å–œæ¬¢çš„é‚£å¥è¯

## æ—ä¸­æœ‰ä¸¤æ¡è·¯ï¼Œæˆ‘é€‰æ‹©äº†äººè¿¹æ›´å°‘çš„é‚£ä¸€æ¡ï¼Œä¸€åˆ‡çš†æºäºæ­¤ ã€€ã€€ ----ç½—ä¼¯ç‰¹Â·å¼—ç½—æ–¯ç‰¹ 

_____


## æ„Ÿè°¢ğŸ™æ‚¨èƒ½æœ‰è€å¿ƒçœ‹åˆ°è¿™é‡Œ
## å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥åŠ é˜¿å¸ƒçš„å¾®ä¿¡ 
## å¾®ä¿¡å·ï¼šaaaabbbuu



![mmexport1475383814280.jpg](http://upload-images.jianshu.io/upload_images/3136804-72f25ff3f459f52a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)