
# æ‰“å¼€è‚¡ç¥¨é‡åŒ–çš„é»‘ç®±(è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº) ç¬¬å…­ç« 

### ä½œè€…ï¼šé˜¿å¸ƒğŸ¶

### æœªç»æœ¬äººå…è®¸ç¦æ­¢è½¬è½½
____
##  éå‡è¡¡èƒœè´Ÿæ”¶ç›Šå¸¦æ¥çš„å¿…ç„¶éå‡è¡¡èƒœè´Ÿæ¯”ä¾‹ï¼Œç›®æ ‡ç”±å› å­çš„èƒ½åŠ›è§£å†³ä¸€éƒ¨åˆ†ï¼Œæ¨¡è¯†åˆ«æå‡å…³é”®çš„ä¸€éƒ¨åˆ†

ä¸Šä¸€ç« ä½¿ç”¨gmm-hmmç»Ÿè®¡åˆ†æåˆ†ç±»ï¼Œè¿›è¡Œæ¨¡å¼è¯†åˆ«ï¼Œå¤§ä½“æ€è·¯å·²ç»è¯´æ˜ï¼Œè¿™ä¸€ç« å¼€å§‹ï¼Œå…·ä½“å®Œå–„è¿™ä¸ªæ–¹æ³•ï¼Œæé«˜èƒœç‡è¿™ä¸€ç« å°†å¼•å…¥è£åˆ¤æœºåˆ¶ï¼Œä¸»è£ä¸è¾…åŠ©è£åˆ¤

ä¾ç„¶æ˜¯ä»åŠ è½½æ•°æ®å¼€å§‹


	fn = ZEnv.g_project_root + '/data/cache/golden_n6_test_abu'
	key = 'golden_n6_test_abu'
	orders_pd_test = ZCommonUtil.load_hdf5(fn, key)
	orders_pd_test.shape
		# out
		(4837, 31)

___

	fn =  ZEnv.g_project_root + '/data/cache/golden_n6_train_abu'
	key = 'golden_n6_train_abu'
	orders_pd_train = ZCommonUtil.load_hdf5(fn, key)
	orders_pd_train.shape
		# out
		(42538, 31)

å’Œä¹‹å‰ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œä½¿ç”¨å…¨é‡æµ‹è¯•é›†æ•°æ®ï¼Œæ²¡æœ‰åˆ†å‰²æµ‹è¯•é›†ä¸è®­ç»ƒé›†çš„æ•°æ®ä¸ºçš„æ˜¯ä¹‹åæ„å»ºä¸»è£å°†ä½¿ç”¨è¿™ä»½å…¨é‡çš„æ•°æ®ä½œä¸ºè®­ç»ƒé›†ï¼Œä¸å†åˆ‡å‰²çš„ç›®çš„æ˜¯æ‹…å¿ƒgmmï¼hmmåªæ˜¯è¯†åˆ«äº†è¿™æ®µæ—¶é—´å†…çš„ç‰¹å¾ï¼Œå¯¹åŒä¸€æ—¶æ®µå†…çš„ä¸åŒè‚¡ç¥¨äº¤æ˜“å¯ä»¥ç”Ÿæ•ˆï¼Œä½†æ˜¯å®ç›˜å°±ä¸ç®¡ç”¨äº†ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¸åˆ‡å‰²æ•°æ®ï¼Œè®­ç»ƒå®Œæ•´ä¸ªæ¨¡å‹ä¹‹åå†å‘å‰å›æº¯ä¸€æ•´å¹´çš„æ•°æ®ä½œä¸ºæµ‹è¯•æ•°æ®é›†

	fn = ZEnv.g_project_root + '/data/cache/orders_pd_ump_hit_predict_abu'
	key = 'orders_pd_ump_hit_predict_abu'
	orders_pd_ump = ZCommonUtil.load_hdf5(fn, key)
	orders_pd_ump.shape
		# out
		(47374, 39)

ä¸Šä¸€ç« åªç”¨åˆ°äº†UmpMainClass ä¹Ÿå°±æ˜¯**ä¸»è£**ï¼Œæœ¬å‘¨å¼•å…¥è¾…åŠ©è£åˆ¤æ¦‚å¿µï¼Œè¿™é‡Œçš„å®ä¾‹å°±æ˜¯è·³ç©ºè£åˆ¤å¯¹è¿™é‡Œçš„è·³ç©ºå®ç°æ„Ÿå…´è¶£çš„è¯·å‚è€ƒæ–‡ç« çš„ç¬¬ä¸€ç« å…³äºè·³ç©ºçš„ç¤ºä¾‹ï¼Œä¹Ÿå¯æŸ¥çœ‹æºä»£ç TLineJump.py

**jump ump è¾…åŠ©è£å†³**

	# åªé’ˆå¯¹æœ‰21å¤©å†…æœ‰è·³ç©ºè¡Œä¸ºçš„äº¤æ˜“ï¼Œä¸€ä¸‹å­å°±åªå‰©ä¸‹5035äº†ï¼Œåªç®€å•è·³ç©ºå¼ºåº¦å’Œè·³ç©ºé—´éš”å¤©æ•°ä¸¤ä¸ªç‰¹å¾ç»„æˆ
	ump_jump = UmpJumpClass(orders_pd_ump, MlFiterJumpPdClass, dd_threshold=21)
	ZLog.info(ump_jump.fiter.df.shape)
	ump_jump.fiter.df.head()
		# out
		(5035, 3)


![Snip20161021_34.png](http://upload-images.jianshu.io/upload_images/3136804-68893500e9a0424f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

	# è¿™ä¸ªä½ åº”è¯¥ç†Ÿæ‚‰äº†ï¼Œçœ‹çœ‹è¿™äº›æ•°æ®çš„äº¤æ˜“å¤§ä½“æƒ…å†µï¼Œç¬¬ä¸€ä¸ªä¸è¿‡æ»¤æ•°æ®ï¼Œå³æ‰€æœ‰ä¼ è¿›å»çš„4wå¤šæ¡äº¤æ˜“
	ump_jump.show_general()
	# è¿‡æ»¤æ•°æ®ï¼Œåªç»Ÿè®¡ç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œå³é‚£5åƒå¤šæ¡çš„æƒ…å†µ
	ump_jump.show_general(use_fiter=True)
___
		all fit order = (44906, 39)
		win rate = 0.500757137131
		profit_cg.sum() = 272.117613217
		win mean = 0.0743788075658 loss_mean = -0.0626291433739 


![output_12_1.png](http://upload-images.jianshu.io/upload_images/3136804-12159820a3dcb8a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

		all fit order = (5035, 39)
		win rate = 0.498907646475
		profit_cg.sum() = 20.2331512267
		win mean = 0.0673137719871 loss_mean = -0.0591414557032 



![output_12_3.png](http://upload-images.jianshu.io/upload_images/3136804-619bab65f80abdde.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**ä»ä¸Šé¢å¯ä»¥å‘ç°è·³ç©ºç›‘æ§åŒºï¼Œæ”¶ç›Šå°äºæ•´ä¸ªåŒºé—´**

æ­»å¿ƒä¸æ”¹çš„ä»ç„¶ä½¿ç”¨svmå¯¹æ¨¡å‹æƒ³è¦æŠ½å–ç‰¹å¾ï¼Œç»“æœğŸ™ˆ

	ump_jump.fiter().estimator.svc()
	ump_jump.fiter().train_test_split_xy()
		# out
		(5035, 2)
		(4531, 2)
		(504, 2)
		accuracy = 0.56
		precision_score = 0.57
		recall_score = 0.54
		             precision    recall  f1-score   support

		        0.0       0.55      0.59      0.57       247
		        1.0       0.57      0.54      0.56       257

		avg / total       0.56      0.56      0.56       504

		Confusion Matrix  [[145 102]
		 [119 138]]
		          Predicted
		         |  0  |  1  |
		         |-----|-----|
		       0 | 145 | 102 |
		Actual   |-----|-----|
		       1 | 119 | 138 |
		         |-----|-----|

### ä¸‹é¢ç»§ç»­ä½¿ç”¨gmm-hmmæ–¹å¼è¿›è¡Œç‰¹å¾æŠ½å–, ç”±äºæ•°æ®ä¸å¤šï¼Œä»18ä¸ªåˆ†ç±»åˆ°42ä¸ªåˆ†ç±»ï¼Œé˜€å€¼è¿˜æ˜¯é€‰æ‹©65%

    ump_jump.gmm_component_filter(p_ncs=np.arange(18, 42), threshold=0.65)

![output_17_0.png](http://upload-images.jianshu.io/upload_images/3136804-369166f2caecf558.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

    

![output_17_1.png](http://upload-images.jianshu.io/upload_images/3136804-e6dcf81d6c1ae3b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![Snip20161021_36.png](http://upload-images.jianshu.io/upload_images/3136804-2491000aaab81f83.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


å¦‚ä¸‹æ‰€ç¤ºæ‰¾ä¸ªæ•°é‡å’Œå¤±è´¥ç‡éƒ½å¾ˆé«˜çš„åˆ†ç±»çœ‹çœ‹å‘ç°ç‰¹å¾äº†å—ï¼Ÿè·³ç©ºç¼ºå£çš„èƒ½é‡å¤§æ¦‚åœ¨ï¼1.6å·¦å³ï¼Œè·³ç©ºæ—¶é—´é—´éš”å¤§çº¦æ˜¯9-11è¿™ä¸ªç±»åˆ«é‡Œå› å­è§¦å‘çš„70%äº¤æ˜“éƒ½ä»¥å¤±è´¥å‘Šç»ˆï¼Œæ‰€ä»¥å‘¢ï¼Ÿæ‹¦æˆªå‘—ï¼ï¼ˆæ‹¦æˆªè¿™ä¸ªè¯å¯¹æˆ‘æœ‰ç§ç‰¹æ®Šçš„æƒ…æ€€ï¼Œé‚£æ®µç¾å¥½çš„é’æ˜¥å²æœˆå¥½æ€€å¿µğŸ‘»ï¼‰

    ump_jump.nts['21_18']
**ç”±äºç®€ä¹¦åªèƒ½æˆªå›¾æ˜¾ç¤ºè¡¨æ ¼ï¼Œå®Œæ•´è¯·å‚é˜…gitä¸Šipython notebookç‰ˆæœ¬**
![Snip20161021_38.png](http://upload-images.jianshu.io/upload_images/3136804-40f30e3c3f41c914.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ä¸‹é¢ç»Ÿè®¡ä¸€ä¸‹è·³ç©ºèƒ½é‡çš„åˆ†å¸ƒæƒ…å†µï¼Œè¿›ä¸€æ­¥æ€»ç»“ç‰¹å¾

	import scipy.stats as scs
	import MlFiterBinsCs
	ZLog.info(scs.normaltest(ump_jump.fiter.df.jump_power))
	MlFiterBinsCs.show_orders_hist(ump_jump.fiter.df, s_list = ['jump_power'])
		# out
		NormaltestResult(statistic=11612.386867948926, pvalue=0.0)
		
		jump_power show hist and qcuts
		(-1.0692, -1.000217]    504
		(-1.243, -1.149]        504
		(-1.669, -1.499]        504
		(-2.304, -1.932]        504
		[-123.0916, -3.0491]    504
		(-1.149, -1.0692]       503
		(-1.366, -1.243]        503
		(-1.499, -1.366]        503
		(-1.932, -1.669]        503
		(-3.0491, -2.304]       503
		Name: jump_power, dtype: int64


![output_21_1.png](http://upload-images.jianshu.io/upload_images/3136804-c7a240782dd6884d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**å¦‚ä¸‹jump poweré€‰å–llpsæ²¡æœ‰æ‰§è¡Œæœ€ä¼˜åŒ–æ±‚è§£ï¼Œå› ä¸ºæ•°æ®é‡å¤ªå°‘ï¼ŒæŒ‰ç…§åˆ†ç±»æ•°ç›®è¦æ±‚å¤§äº20, å…¶å®ƒ0ï¼Œ 0ï¼Œ 0.65æ¥è·‘è·‘çœ‹çœ‹å…ˆ**

    llps = ump_jump.cprs[(ump_jump.cprs['lps'] <= 0) & (ump_jump.cprs['lms'] <= 0 ) 
                & (ump_jump.cprs['lrs'] >=0.65) & (  (ump_jump.cprs['lcs'] >= 20)
                                                    | (ump_jump.cprs['lrs'] == 1) )]
    llps



![Snip20161021_39.png](http://upload-images.jianshu.io/upload_images/3136804-2f29b89e6a6e967c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

é¢„æµ‹åº”ç”¨è¿™ä¸ªåçš„æ•ˆæœèƒ½ä½“é«˜0.013

    ump_jump.choose_cprs_component(llps)
		# out
		nts_pd.shape = (182, 6)
		nts_pd loss rate = 0.681318681319
		improved rate = 0.0131082423039
		predict win rate = 0.512015888779



![output_25_1.png](http://upload-images.jianshu.io/upload_images/3136804-1516e2a0a5e0bf3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ¬åœ°åºåˆ—åŒ–

    ump_jump.dump_clf(llps)


å¥½äº†ï¼Œå‡†å¤‡è¿›å…¥æ­£é¢˜ï¼Œåšå¥½å‡†å¤‡ï¼Œå‰æ–¹é«˜èƒ½

### åªæœ‰ä¸€ä¸ªä¸»è£æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ å¤šä¸ªä¸»è£ï¼Œå¤šä¸ªè¾…åŠ©è£åˆ¤ï¼Œè¿˜æœ‰è¾¹è£ï¼ˆè¾¹è£ä¸‹ä¸€ç« ä»‹ç»ï¼‰
deg ump ä¸»è£ï¼Œåªä½¿ç”¨å…¨å±€æœ€ä¼˜llps

    from MlFiterDegPd import MlFiterDegPdClass
    ump_deg = UmpMainClass(orders_pd_ump, MlFiterDegPdClass)
    ump_deg.fiter.df.head(2)


![Snip20161021_40.png](http://upload-images.jianshu.io/upload_images/3136804-2e3aeae5e864e525.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

    ump_deg.gmm_component_filter(p_ncs=np.arange(18, 85), threshold=0.68)



![output_32_0.png](http://upload-images.jianshu.io/upload_images/3136804-2e0d53661a28a365.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![output_32_1.png](http://upload-images.jianshu.io/upload_images/3136804-f4efee061232a2a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


	# åªä½¿ç”¨å…¨å±€å‡¸ä¼˜åŒ–å¯»æ‰¾æœ€ä¼˜
	brust_min = ump_deg.brust_min()
	llps = ump_deg.cprs[(ump_deg.cprs['lps'] <= brust_min[0]) & (ump_deg.cprs['lms'] <= brust_min[1] ) & 
	                    (ump_deg.cprs['lrs'] >= brust_min[2])]
	ump_deg.choose_cprs_component(llps)
	ump_deg.dump_clf(llps)
		ï¼ƒ out
		nts_pd.shape = (513, 7)
		nts_pd loss rate = 0.690058479532
		improved rate = 0.00434240413308
		predict win rate = 0.505099541264



![output_33_1.png](http://upload-images.jianshu.io/upload_images/3136804-f68add2e256e45b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


______

wave umpç¬¬äºŒä¸»è£

    ump_wave = UmpMainClass(orders_pd_ump, MlFiterWavePdClass)
    ump_wave.fiter.df.head(2)
 


![Snip20161021_41.png](http://upload-images.jianshu.io/upload_images/3136804-2d053a6cc4043d91.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


    ump_wave.gmm_component_filter(p_ncs=np.arange(18, 85), threshold=0.63)


![output_37_0.png](http://upload-images.jianshu.io/upload_images/3136804-711fd96c252d54cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![output_37_1.png](http://upload-images.jianshu.io/upload_images/3136804-97cae46407844986.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


	brust_min = ump_wave.brust_min()
	llps = ump_wave.cprs[(ump_wave.cprs['lps'] <= brust_min[0]) & (ump_wave.cprs['lms'] <= brust_min[1] ) & 
	                    (ump_wave.cprs['lrs'] >= brust_min[2])]
	ump_wave.choose_cprs_component(llps)
	ump_wave.dump_clf(llps)
		# out
		nts_pd.shape = (1126, 7)
		nts_pd loss rate = 0.639431616341
		improved rate = 0.00699238409121
		predict win rate = 0.507749521222



![output_38_1.png](http://upload-images.jianshu.io/upload_images/3136804-b9ec2a5d950907e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç¬¬ä¸‰ä¸»è£ ump_main

    # æ„é€ æ–¹å¼æ¢æ±¤ä¸æ¢è¯ï¼Œå¯ä»¥ç»§ç»­å°è£…ä¼˜åŒ–
    from MlFiterMainPd import MlFiterMainPdClass
    ump_main = UmpMainClass(orders_pd_ump, MlFiterMainPdClass)
    ump_main.fiter.df.head(2)


    
![Snip20161021_42.png](http://upload-images.jianshu.io/upload_images/3136804-02c921a1fc102ddc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


    ump_main.gmm_component_filter(p_ncs=np.arange(18, 80), threshold=0.65)


![output_42_0.png](http://upload-images.jianshu.io/upload_images/3136804-721aa431a7c7f18a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![output_42_1.png](http://upload-images.jianshu.io/upload_images/3136804-1d7ec2cc71393050.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


	brust_min = ump_main.brust_min()
	llps = ump_main.cprs[(ump_main.cprs['lps'] <= brust_min[0]) & (ump_main.cprs['lms'] <= brust_min[1] ) & 
	                    (ump_main.cprs['lrs'] >= brust_min[2])]
	ump_main.choose_cprs_component(llps)
	ump_main.dump_clf(llps)
		ï¼ƒ out
		nts_pd.shape = (804, 7)
		nts_pd loss rate = 0.661691542289
		improved rate = 0.00578987217744
		predict win rate = 0.506547009308



![output_43_1.png](http://upload-images.jianshu.io/upload_images/3136804-09f0800a3dfac671.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


è‡³æ­¤ï¼Œæ‰€æœ‰ä¸»è£æ„å»ºå®Œæˆï¼Œä¸‹ä¸€ç« å¼€å§‹æ„é€ è¾¹è£ï¼Œæ‰€æœ‰è£åˆ¤éƒ½åˆ°ä½åï¼Œå’±ä»¬çš„çƒèµ›å°±ä¼šå¼€åœºï¼

____

## æ„Ÿè°¢ğŸ™æ‚¨èƒ½æœ‰è€å¿ƒçœ‹åˆ°è¿™é‡Œ
## å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥åŠ é˜¿å¸ƒçš„å¾®ä¿¡ 
## å¾®ä¿¡å·ï¼šaaaabbbuu


![mmexport1475383814280.jpg](http://upload-images.jianshu.io/upload_images/3136804-4f7f75ddf01f331a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)