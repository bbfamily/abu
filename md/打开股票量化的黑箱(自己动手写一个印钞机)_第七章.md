# æ‰“å¼€è‚¡ç¥¨é‡åŒ–çš„é»‘ç®±(è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº) ç¬¬ä¸ƒç« 

### ä½œè€…ï¼šé˜¿å¸ƒğŸ¶

### æœªç»æœ¬äººå…è®¸ç¦æ­¢è½¬è½½

____

##  éå‡è¡¡èƒœè´Ÿæ”¶ç›Šå¸¦æ¥çš„å¿…ç„¶éå‡è¡¡èƒœè´Ÿæ¯”ä¾‹ï¼Œç›®æ ‡ç”±å› å­çš„èƒ½åŠ›è§£å†³ä¸€éƒ¨åˆ†ï¼Œæ¨¡å¼è¯†åˆ«æå‡å…³é”®çš„ä¸€éƒ¨åˆ†

___

ä¸Šä¸€ç« æ„é€ äº† 3ä¸ªä¸»è£å’Œä¸€ä¸ªè¾…åŠ©è£åˆ¤ï¼Œè¿™ä¸€ç« å¼€å§‹æ„å»ºè¾¹è£åŠè£åˆ¤çš„æœ€ä¼˜å‚æ•°é€‰æ‹©

	fn = ZEnv.g_project_root + '/data/cache/orders_pd_ump_hit_predict_abu'
	key = 'orders_pd_ump_hit_predict_abu'
	orders_pd_ump = ZCommonUtil.load_hdf5(fn, key)
	orders_pd_ump.shape
		# out
		(47374, 39)

**UmpEdge è¾¹è£**

    import UmpEdge
    ump_edge = UmpEdge.UmpEdgeClass(orders_pd_ump)

**è¾¹è£ä½¿ç”¨profitï¼Œ profit_cgä½œä¸ºgmmåˆ†ç±»æ•°æ®ç”Ÿæˆssåˆ†ç±»åºåˆ—ï¼Œä¹‹åæ ¹æ®profit_cgè¿›è¡Œrankæ•°æ®ç”Ÿæˆp_rk_cgï¼Œå†æ‰¾åˆ°top winNï¼Œtop lossN Nç°åœ¨çš„è®¾ç½®æ˜¯25%ä¸”å¯¹å¤–ä¸æš´éœ²ï¼Œåˆ†åˆ«ç»™äº1ï¼Œ -1, å…¶å®ƒçš„éƒ½æ˜¯0ç”Ÿæˆrkåˆ—ï¼Œå°†atrï¼Œdegï¼Œwaveæ‰€æœ‰æ•°æ®çš„numpyçŸ©é˜µä¿å­˜èµ·æ¥ï¼Œå¯¹è¾“å…¥çš„æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–åå®è¡Œè·ç¦»å¯¹æ¯”ï¼Œæ‰¾åˆ°æœ€åŒ¹é…çš„rkæ ‡ç­¾**


### ç®€å•è¯´å°±æ˜¯å¼•å…¥äº¤æ˜“åç½®å‚æ•°æ”¶ç›Šï¼ŒæŠŠæ”¶ç›Šçš„top 25%å•å­ï¼Œå’Œblow 25%çš„å•å­çš„ç‰¹å¾æŠ½å–ï¼Œä½†æ˜¯ç”±äºåœ¨å®é™…äº¤æ˜“é‚£ä¸€æ—¶åˆ»æ²¡æœ‰æ”¶ç›Šè¿™ä¸ªå˜é‡ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥é¢„æµ‹ï¼Œæ‰€ä»¥ä¹‹å‰å°†ç‰¹å¾çš„xé¢„å¤„ç†åšæ ‡å‡†åŒ–ï¼Œå†ä½¿ pairwise_distancesè®¡ç®—è¾“å…¥çš„ç›¸ä¼¼åº¦æœ€ç›¸ä¼¼é‚£ä¸ªé¢„å­˜xï¼Œå½±å°„å‡ºé‚£ä¸ªxæ˜¯å¦åœ¨top25%æˆ–è€…below25%, æ˜ç™½äº†å—ï¼Ÿä¸æ˜ç™½å°±çœ‹æºä»£ç å§ï¼Œä¸‹é¢ä¹Ÿè´´äº†ä¸€æ®µ

æ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ–è€…ç›´æ¥æŸ¥é˜…æºä»£ç UmpEdge.py

    def dump_clf(self):
        dump_clf = {'top_loss_ss': self.top_loss_ss, 'top_win_ss': self.top_win_ss,
                    'fiter_df': self.fiter.df, 'fiter_x': self.fiter.x}

        ZCommonUtil.dump_pickle(dump_clf, self.dump_file_fn())

    def predict(self, **kwargs):

        dump_clf = UmpEdgeClass.dump_clf_manager.get_ump(self)

        x = np.array([kwargs[col] for col in dump_clf['fiter_df'].columns[2:-3]])

        x = x.reshape(1, -1)
        con_x = np.concatenate((x, dump_clf['fiter_x']), axis=0)

        x_scale_param = self.scaler.fit(con_x)
        con_x = self.scaler.fit_transform(con_x, x_scale_param)

        distance_min_ind = pairwise_distances(con_x[0].reshape(1, -1), con_x[1:],
                                              metric='euclidean').argmin()
        '''
            ç½®æ¢å‡ºå¯ä»¥ä½œä¸ºåˆ†ç±»è¾“å…¥çš„x
        '''
        ss = dump_clf['fiter_df'].iloc[distance_min_ind]['ss']
        if ss in dump_clf['top_loss_ss']:
            return -1
        elif ss in dump_clf['top_win_ss']:
            return 1
        return 0

    def gmm_component_filter(self, nc=20, threshold=0.72, show=True):
        clf = GMM(nc, n_iter=500, random_state=3).fit(self.fiter.y)
        ss = clf.predict(self.fiter.y)

        self.fiter.df['p_rk_cg'] = self.fiter.df['profit_cg'].rank()
        self.fiter.df['ss'] = ss

        win_top = len(self.fiter.df['profit_cg']) - len(self.fiter.df['profit_cg']) * 0.25
        loss_top = len(self.fiter.df['profit_cg']) * 0.25
        self.fiter.df['rk'] = 0
        self.fiter.df['rk'] = np.where(self.fiter.df['p_rk_cg'] > win_top, 1, self.fiter.df['rk'])
        self.fiter.df['rk'] = np.where(self.fiter.df['p_rk_cg'] < loss_top, -1, self.fiter.df['rk'])

        xt = pd.crosstab(self.fiter.df['ss'], self.fiter.df['rk'])
        xt_pct = xt.div(xt.sum(1).astype(float), axis=0)

        if show:
            xt_pct.plot(
                figsize=(16, 8),
                kind='bar',
                stacked=True,
                title=str('ss') + ' -> ' + str('result'))
            plt.xlabel(str('ss'))
            plt.ylabel(str('result'))

            ZLog.info(xt_pct[xt_pct[-1] > threshold])
            ZLog.info(xt_pct[xt_pct[1] > threshold])

        self.top_loss_ss = xt_pct[xt_pct[-1] > threshold].index
        self.top_win_ss = xt_pct[xt_pct[1] > threshold].index
        return xt, xt_pct

___

ump_edge.fiter.df.head()




![Snip20161021_46.png](http://upload-images.jianshu.io/upload_images/3136804-05f7f7a7a0e9cc3e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


### å¦‚ä¸‹å¯è§†åŒ–æ˜¯ä¸æ˜¯æ›´æ˜ç™½ç‚¹äº†ï¼Œtop 25æ˜¯1ï¼Œ below 25æ˜¯ï¼1ï¼Œå…¶å®ƒçš„éƒ½ç”¨0ä»£è¡¨ï¼Œgmmåˆ†ç±»ä¹‹årank profitï¼Œå¤§äºé˜€å€¼çš„ç±»åˆ«å¾—åˆ°ä¿ç•™ï¼Œè¿™äº›ç±»åˆ«å¦‚ä¸‹æ‰€ç¤º

    xt, xt_pct = ump_edge.gmm_component_filter(nc=20, threshold=0.72, show=True)
        # out
		rk   -1    0    1
		ss               
		0   1.0  0.0  0.0
		6   1.0  0.0  0.0
		7   1.0  0.0  0.0
		9   1.0  0.0  0.0
		19  1.0  0.0  0.0
		rk   -1         0         1
		ss                         
		2   0.0  0.000000  1.000000
		4   0.0  0.000000  1.000000
		5   0.0  0.000000  1.000000
		10  0.0  0.000000  1.000000
		11  0.0  0.000000  1.000000
		12  0.0  0.028401  0.971599
		13  0.0  0.000000  1.000000
		16  0.0  0.000000  1.000000
		18  0.0  0.000000  1.000000


![output_13_1.png](http://upload-images.jianshu.io/upload_images/3136804-9606d18890498912.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### pd.crosstabäº¤ç»‡è¡¨ç”Ÿæˆgmmç”Ÿæˆçš„ç±»åˆ«ä¸rkçš„äº¤ç»‡ç»“æœ

xt

| rk | -1 | 0 | 1 |
| --- | --- | --- | --- |
| ss |  |  |  |
| --- | --- | --- | --- |
| 0 | 2465 | 0 | 0 |
| 1 | 0 | 4326 | 241 |
| 2 | 0 | 0 | 4 |
| 3 | 1073 | 4038 | 0 |
| 4 | 0 | 0 | 3053 |
| 5 | 0 | 0 | 33 |
| 6 | 47 | 0 | 0 |
| 7 | 3633 | 0 | 0 |
| 8 | 103 | 4799 | 0 |
| 9 | 886 | 0 | 0 |
| 10 | 0 | 0 | 20 |
| 11 | 0 | 0 | 978 |
| 12 | 0 | 114 | 3900 |
| 13 | 0 | 0 | 2 |
| 14 | 0 | 3249 | 1036 |
| 15 | 0 | 4346 | 1 |
| 16 | 0 | 0 | 213 |
| 17 | 2892 | 1536 | 0 |
| 18 | 0 | 0 | 1723 |
| 19 | 104 | 0 | 0 |

xt_pct


| rk | -1 | 0 | 1 |
| --- | --- | --- | --- |
| ss |  |  |  |
| --- | --- | --- | --- |
| 0 | 1.000000 | 0.000000 | 0.000000 |
| 1 | 0.000000 | 0.947230 | 0.052770 |
| 2 | 0.000000 | 0.000000 | 1.000000 |
| 3 | 0.209939 | 0.790061 | 0.000000 |
| 4 | 0.000000 | 0.000000 | 1.000000 |
| 5 | 0.000000 | 0.000000 | 1.000000 |
| 6 | 1.000000 | 0.000000 | 0.000000 |
| 7 | 1.000000 | 0.000000 | 0.000000 |
| 8 | 0.021012 | 0.978988 | 0.000000 |
| 9 | 1.000000 | 0.000000 | 0.000000 |
| 10 | 0.000000 | 0.000000 | 1.000000 |
| 11 | 0.000000 | 0.000000 | 1.000000 |
| 12 | 0.000000 | 0.028401 | 0.971599 |
| 13 | 0.000000 | 0.000000 | 1.000000 |
| 14 | 0.000000 | 0.758226 | 0.241774 |
| 15 | 0.000000 | 0.999770 | 0.000230 |
| 16 | 0.000000 | 0.000000 | 1.000000 |
| 17 | 0.653117 | 0.346883 | 0.000000 |
| 18 | 0.000000 | 0.000000 | 1.000000 |
| 19 | 1.000000 | 0.000000 | 0.000000 |



### æœ€åçš„å¸¸è§„ä»»åŠ¡å°±æ˜¯å°†è£åˆ¤æœ¬åœ°åºåˆ—è¯

    ump_edge.dump_clf()

_____

##  ä¸‹é¢çš„ä¸»é¢˜æ˜¯å¯»æ‰¾è£åˆ¤æœ€ä¼˜å‚æ•°

### å°†orders_pd_umpæ•°æ®é‡æ–°è¯»å–ï¼Œæ–°çš„æ•°æ®åŒ…æ¶µäº†ä½¿ç”¨è¿™äº›è£åˆ¤è¿›è¡Œè£å†³ï¼Œä½†ä¸æ‹¦æˆªçš„æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼Œå½¢å¼å¦‚ä¸‹æ‰€ç¤ºè¡¨æ ¼æ‰€ç¤ºï¼Œé€šè¿‡æ•°æ®ç»Ÿè®¡æ¥ç»„ç»‡æ‹¦æˆªè§„åˆ™ï¼Œæ¯”å¦‚å‡ ä¸ªä¸»è£ä¸€èµ·åˆä½œï¼Œè¾¾åˆ°å‡ ä¸ªhitå°±ç›´æ¥æ‹¦æˆªï¼Œå‡ ä¸ªç­‰å¾…è¾¹è£è£å†³ï¼Œè¾…åŠ©è£åˆ¤åº”ç”¨èµ‹äºˆçš„æƒåŠ›æƒé‡ï¼Œè¿™äº›å‚æ•°è®¾ç½®å¥½äº†ä¹‹åå°±å¯ä»¥ç»„æˆä¸€ä¸ªå®ç”¨çš„äº¤æ˜“æ‹¦æˆªç³»ç»Ÿï¼

    orders_pd_ump.filter(regex='result|ump_main_mlfiter*|ind_key').tail(2)



![
![Uploading Snip20161021_48_082768.png . . .]
](http://upload-images.jianshu.io/upload_images/3136804-a3fbcdd985324493.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


	# å…ˆå¯¹ä¸‰ä¸ªä¸»è£å¯»æ‰¾å‚æ•°ï¼Œä¸»è£çš„ä¼˜å…ˆçº§æ˜¯ä¸€è‡´çš„ï¼Œè‡³å°‘è¿™é‡Œæ˜¯è¿™æ ·å®ç°çš„

	from MlFiter import MlFiterClass

	orders_pd_ump['ind_key'] = np.arange(0, len(orders_pd_ump))
	orders_pd_tmp = orders_pd_ump.filter(regex='result|ump_main_mlfiter*|ind_key')
	order_has_ret = orders_pd_tmp[orders_pd_tmp['result'] <> 0]
	order_has_ret['result'] = np.where(order_has_ret['result'] == -1, 0, 1)

	order_has_ret['ump_main_mlfitermainpdclass_predict'] = np.where(order_has_ret['ump_main_mlfitermainpdclass_predict'] == True, 1, 0)
	order_has_ret['ump_main_mlfiterdegpdclass_predict'] = np.where(order_has_ret['ump_main_mlfiterdegpdclass_predict'] == True, 1, 0)
	order_has_ret['ump_main_mlfiterwavepdclass_predict'] = np.where(order_has_ret['ump_main_mlfiterwavepdclass_predict'] == True, 1, 0)

	order_has_ret = order_has_ret[(order_has_ret['ump_main_mlfitermainpdclass_predict'] == 0) | 
	                              (order_has_ret['ump_main_mlfiterdegpdclass_predict'] == 0) | 
	                              (order_has_ret['ump_main_mlfiterwavepdclass_predict'] == 0)]

	order_has_ret['predict_sum'] = order_has_ret['ump_main_mlfitermainpdclass_predict'] + order_has_ret['ump_main_mlfiterdegpdclass_predict'] + \
	            order_has_ret['ump_main_mlfiterwavepdclass_predict']

	order_has_ret['hit_sum'] = order_has_ret['ump_main_mlfiterdegpdclass_hit'] + order_has_ret['ump_main_mlfitermainpdclass_hit'] + \
	            order_has_ret['ump_main_mlfiterdegpdclass_hit']
	    
	matrix = order_has_ret.as_matrix()
	y = matrix[:, 0]
	x = matrix[:, 1:]
	fiter = MlFiterClass(x, y, order_has_ret)
	fiter.df.head()
	order_has_ret.head()




![Snip20161021_48.png](http://upload-images.jianshu.io/upload_images/3136804-441c95531d1755e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


**ç”±äºç®€ä¹¦ä¸æ”¯æŒhtmlçš„è¡¨æ ¼ï¼Œå®Œæ•´çš„è¯·å‚é˜…gitä¸Šçš„ipython notebookç‰ˆæœ¬**

è¿™é‡Œä¸ºäº†è®©ä½ èƒ½çœ‹æ‡‚æˆ‘å°†è¡¨æ ¼åšä¸ªTå†æˆªä¸€å¼ å›¾ï¼Œæœ‰æ¡ä»¶è¯·å‚é˜…notebookç‰ˆæœ¬

    order_has_ret.T


![Snip20161021_49.png](http://upload-images.jianshu.io/upload_images/3136804-222d61326b10643a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


é€šè¿‡å¯è§†åŒ–å¯»æ‰¾å‚æ•°ï¼Œç»¼åˆå‚è€ƒæ•°é‡ï¼Œæ¦‚ç‡ç­‰å¤šæ–¹é¢å› ç´ 

**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ1ä¸ªhitä»¥ä¸Šå°±ä¸Š0.65äº† 20ä¸ªhit 0.70ä»¥ä¸Šï¼Œ> 20ä¸ªå°±å¯ä»¥ä¸»è£ç›´æ¥ä½¿ç”¨è£å†³äº†ï¼Œå°äºçš„ç­‰å¾…ï¼Œè¾…åŠ©è£åˆ¤ï¼Œè¾¹è£**

	from sklearn import metrics
	import matplotlib.pyplot as plt

	hd_range = np.arange(0, 50)
	hd_result = []
	hd_sum = []
	for hd in hd_range:
	    xt = order_has_ret[(order_has_ret['hit_sum'] > hd)]['result'].value_counts()
	    hs = xt.sum()
	    hd_sum.append(hs)
	    hd_result.append(float(xt[0])/hs)
	    
	cmap = plt.get_cmap('jet', 20)
	cmap.set_under('gray')
	fig, ax = plt.subplots()
	ax.plot(hd_range, hd_result)
	cax = ax.scatter(hd_range, hd_result, c=hd_sum, cmap=cmap, vmin=np.min(hd_sum),
	                 vmax=np.max(hd_sum))
	ax.grid(True)
	fig.colorbar(cax, label='hd_sum', extend='min')



![output_24_1.png](http://upload-images.jianshu.io/upload_images/3136804-99be5e035557680e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


**è·³ç©ºçš„è¾…åŠ©è£åˆ¤æœ¬èº«æ•°æ®å°±å°‘ï¼Œè¾…åŠ©è£åˆ¤å°½é‡è£å†³ jump umpå¯ä»¥ä½¿ç”¨hit 5ä½œä¸ºé˜€å€¼ï¼Œå¤§äº5ä¸ªhitç›´æ¥è£å†³ï¼Œå¦åˆ™ç­‰å¾…è¾¹è£**


	orders_pd_tmp = orders_pd_ump.filter(regex='result|ump_jump_mlfiter|ind_key*')
	order_has_ret = orders_pd_tmp[orders_pd_tmp['result'] <> 0]
	order_has_ret['result'] = np.where(order_has_ret['result'] == -1, 0, 1)
	order_has_ret['ump_jump_mlfiterjumppdclass_predict'] = np.where(order_has_ret['ump_jump_mlfiterjumppdclass_predict'] == True, 1, 0)

	order_has_ret = order_has_ret[(order_has_ret['ump_jump_mlfiterjumppdclass_predict'] == 0)]

	hd_range = np.unique(order_has_ret['ump_jump_mlfiterjumppdclass_hit'])[:-1]
	# -1 è¦ä½¿ç”¨0å¼€å§‹çš„èŒƒå›´
	hd_range = np.array(hd_range) - 1
	print hd_range
	hd_result = []
	hd_sum = []
	for hd in hd_range:
	    xt = order_has_ret[order_has_ret['ump_jump_mlfiterjumppdclass_hit'] > hd]['result'].value_counts()
	    hs = xt.sum()
	    hd_sum.append(hs)
	    hd_result.append(float(xt[0])/hs)
	    
	cmap = plt.get_cmap('jet', 20)
	cmap.set_under('gray')
	fig, ax = plt.subplots()
	ax.plot(hd_range, hd_result)
	cax = ax.scatter(hd_range, hd_result, c=hd_sum, cmap=cmap, vmin=np.min(hd_sum),
	                 vmax=np.max(hd_sum))
	ax.grid(True)
	fig.colorbar(cax, label='hd_sum', extend='min')



![output_26_2.png](http://upload-images.jianshu.io/upload_images/3136804-b27af9e57982586d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è¾¹è£åœ¨ç°åœ¨çš„è§„åˆ™ä¸­ä¸éœ€è¦éœ€æ‰¾å‚æ•°

å¥½äº†ï¼Œè¿™äº›éƒ½ç»„ç»‡å¥½ä¹‹åï¼Œä¸‹ä¸€ç« å°±è¯¥çœ‹çœ‹è¿™ä¸ªç³»ç»Ÿèƒ½ä¸èƒ½æˆä¸ºå°é’æœºä¹‹è·¯ä¸Šé‚£ä¸ªé‡è¦ç»„æˆç¯èŠ‚äº†ï¼Œä¸‹ä¸€ç« ä¹Ÿæ˜¯æœ€ç»ˆç« èŠ‚ï¼Œå¦‚æœæ‚¨
çœŸçš„èƒ½çœ‹åˆ°è¿™é‡Œï¼Œå¹¶ä¸”å¤§æ¦‚çŸ¥é“æˆ‘å†è¯´äº›ä»€ä¹ˆï¼Œæˆ‘å°±æ„Ÿè§‰å¾ˆæ¬£æ…°äº†ï¼Œå¦‚æœé‚£æ ·çš„è¯å¤šå¤šäº¤æµ

## æ„Ÿè°¢ğŸ™æ‚¨èƒ½æœ‰è€å¿ƒçœ‹åˆ°è¿™é‡Œ
## å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥åŠ é˜¿å¸ƒçš„å¾®ä¿¡ 
## å¾®ä¿¡å·ï¼šaaaabbbuu


![mmexport1475383814280.jpg](http://upload-images.jianshu.io/upload_images/3136804-1973199290094fb7.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)