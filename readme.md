# abuè‚¡ç¥¨é‡åŒ–ç³»ç»Ÿ

#  å°é’æœºç³»ç»Ÿï¼ˆæ‘‡æ»šæˆ˜å›½ï¼‰


**ç®€ä¹¦å…¶å®ƒç« èŠ‚åœ°å€ï¼š**

[è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº ç¬¬ä¸€ç« ](http://www.jianshu.com/p/4ba3a10ea9e5) 
[è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº ç¬¬äºŒç« ](http://www.jianshu.com/p/82885fde3ec2) 
[è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº ç¬¬ä¸‰ç« ](http://www.jianshu.com/p/056d8b28f581) 
[è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº ç¬¬å››ç« ](http://www.jianshu.com/p/ffa63437c991) 
[è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº ç¬¬äº”ç« ](http://www.jianshu.com/p/ca5d766ad70a) 
[è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº ç¬¬å…­ç« ](http://www.jianshu.com/p/c15cdd11367c) 
[è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº ç¬¬ä¸ƒç« ](http://www.jianshu.com/p/7e4108cd4ad1) 

[è‚¡ç¥¨é‡åŒ–ä¸“é¢˜åœ°å€ï¼Œè¯·å…³æ³¨ï¼Œè°¢è°¢ï¼](http://www.jianshu.com/collection/0a774f78050a)


1. æ•°æ®è·å–-ABUé‡åŒ–ç³»ç»Ÿ
2. ç›¸å…³æŒ‡æ ‡-ABUé‡åŒ–ç³»ç»Ÿ
3. åŸºç¡€äº¤æ˜“-ABUé‡åŒ–ç³»ç»Ÿ
4. åº¦é‡å·¥å…·-ABUé‡åŒ–ç³»ç»Ÿ
5. ç†è®ºåŸºç¡€-ABUé‡åŒ–ç³»ç»Ÿ.
6. æœºå™¨å­¦ä¹ -ABUé‡åŒ–ç³»ç»Ÿ
7. è§£å†³æ–¹æ¡ˆA-ABUé‡åŒ–ç³»ç»Ÿ
8. è§£å†³æ–¹æ¡ˆB-ABUé‡åŒ–ç³»ç»Ÿ
9. è§£å†³æ–¹æ¡ˆC-ABUé‡åŒ–ç³»ç»Ÿ
10. è§£å†³æ–¹æ¡ˆD-ABUé‡åŒ–ç³»ç»Ÿ

## éå‡è¡¡èƒœè´Ÿæ”¶ç›Šå¸¦æ¥çš„å¿…ç„¶éå‡è¡¡èƒœè´Ÿæ¯”ä¾‹ï¼Œç›®æ ‡ç”±å› å­çš„èƒ½åŠ›è§£å†³ä¸€éƒ¨åˆ†ï¼Œæ¨¡å¼è¯†åˆ«æå‡å…³é”®çš„ä¸€éƒ¨åˆ†


# readmeä½¿ç”¨æˆ‘è®¤ä¸ºæœ€é‡è¦çš„ä¸€ç« å§



# æ‰“å¼€è‚¡ç¥¨é‡åŒ–çš„é»‘ç®±(è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªå°é’æœº) ç¬¬äº”ç« 

### ä½œè€…ï¼šé˜¿å¸ƒğŸ¶

### æœªç»æœ¬äººå…è®¸ç¦æ­¢è½¬è½½

____


##  éå‡è¡¡èƒœè´Ÿæ”¶ç›Šå¸¦æ¥çš„å¿…ç„¶éå‡è¡¡èƒœè´Ÿæ¯”ä¾‹ï¼Œç›®æ ‡ç”±å› å­çš„èƒ½åŠ›è§£å†³ä¸€éƒ¨åˆ†ï¼Œæ¨¡å¼è¯†åˆ«æå‡å…³é”®çš„ä¸€éƒ¨åˆ†

ä¸Šä¸€ç« ä½¿ç”¨ æ·±åº¦å­¦ä¹ å·ç§¯ç¥ç»ç½‘ç»œå¯¹å°é’æœºä¹‹è·¯è¿›è¡Œäº†å¯è¡Œæ€§åˆ†æï¼Œä¸»è¦æ˜¯åŸºäºtensorflowçš„alex_netæ¨¡å‹å’ŒåŸºäºcaffeä½¿ç”¨google_lenetè¿›è¡Œè®­ç»ƒå­¦ä¹ , è¿™ä¸€ç« æˆ‘ä»¬å°†ä»å¦ä¸€ä¸ªæ–¹å‘å‘å±•å°é’æœºä¹‹è·¯ï¼Œè¿™æ¡è·¯æ˜¯æˆ‘æœ€æ¨èçš„åšæ³•ï¼Œå› ä¸ºä½¿ç”¨æ·±åº¦å­¦ä¹ ç‰¹åˆ«æ˜¯å·ç§¯ç¥ç»ç½‘ç»œï¼Œ**å®ƒæœ€åå­¦ä¹ åˆ°çš„ç‰¹å¾æƒé‡ç­‰ç­‰å¯¹æˆ‘ä»¬éƒ½æ˜¯ä¸€ä¸ªé»‘ç›’ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“å®ƒåˆ°åº•å­¦ä¹ åˆ°äº†ä»€ä¹ˆç‰¹å¾ï¼Œè¿™äº›ç‰¹å¾æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Œä¸ºä»€ä¹ˆå®ƒèƒ½æŒ‡å¯¼æˆ‘ä»¬çš„äº¤æ˜“**ï¼Œè€Œä¸”è®­ç»ƒæ—¶é—´ä¸åˆ¤å®šæ•ˆç‡éƒ½ä¸é«˜ï¼Œå¯¹å¯†é›†å‹äº¤æ˜“ç³»ä¸é€‚ç”¨, ä¸‹é¢æˆ‘ä»¬å¼€å§‹ï¼

è¿™ç« å¼€å§‹çš„ä¸»è§’å°±æ˜¯gmm-hmmäº†ï¼Œå®ƒçš„æœ€æ™®éçš„ç”¨é€”æ˜¯åœ¨è¯­éŸ³è¯†åˆ«ä¸Šï¼Œæˆ‘ä»¬è¿™ç« ä½¿ç”¨å®ƒåšè‚¡ç¥¨æ¨¡å¼è¯†åˆ«

	# é¦–å…ˆåŠ è½½ä¹‹å‰å› å­è¿è¡Œå¥½çš„è®­ç»ƒé›†ä¸æµ‹è¯•é›†æ•°æ®
	fn = ZEnv.g_project_root + '/data/cache/golden_n6_train_abu'
	key = 'golden_n6_train_abu'
	orders_pd_train = ZCommonUtil.load_hdf5(fn, key)
	print orders_pd_train.shape

	fn = ZEnv.g_project_root +  '/data/cache/golden_n6_test_abu'
	key = 'golden_n6_test_abu'
	orders_pd_test = ZCommonUtil.load_hdf5(fn, key)
	print orders_pd_test.shape
		# out
		(42538, 31)
		(4837, 31)

_____

    # å¯¹è®­ç»ƒé›†çš„åº¦é‡
    train_ump = UmpMainClass(orders_pd_train, MlFiterGoldenPdClass)
    train_ump.show_general()
		# out
		all fit order = (40351, 31)
		win rate = 0.500681519665
		profit_cg.sum() = 249.617989344
		win mean = 0.0745965275755 loss_mean = -0.0625759181825 


![output_7_1.png](http://upload-images.jianshu.io/upload_images/3136804-aceb4e1b9c46b78c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

    
* ä½¿ç”¨gmmä»ä¸€å®šèŒƒå›´åˆ†ç±»é»˜è®¤40-85éœ€è¦æ ¹æ®æ ·æœ¬æ•°é‡è¿›è¡Œè°ƒæ•´ï¼Œå¯»æ‰¾compoentä¸­å¤§äºlossé˜€å€¼çš„åˆ†ç±»åˆ†ç±»è®°åšind
* è¿”å›df indexï¼compoent_ind ä¸€ä¸ªcompoentä¸­å¯èƒ½æœ‰å¤šä¸ªind

### è¯´çš„ç®€å•ç‚¹å°±æ˜¯ä½¿ç”¨gmmå¯¹æ•°æ®èšç±»ï¼Œæ¯”å¦‚ä½ å¯¹æ‰€æœ‰æ•°æ®èšç±»èšäº†20ä¸ªåˆ†ç±»ï¼Œç„¶åå‘ç°ç¬¬19ä¸ªåˆ†ç±»é‡Œé¢70ï¼…ä»¥ä¸Šéƒ½æ˜¯èµ”é’±çš„äº¤æ˜“ï¼Œé‚£æˆ‘å°±æå–è¿™ä¸ªåˆ†ç±»çš„çš„è¿™ä¸ªç±»åˆ«ï¼Œä½œä¸ºä¹‹åçš„åˆ¤å®šå™¨çš„ç»„æˆéƒ¨ä»½ï¼Œå¦‚æœæ–°çš„äº¤æ˜“è¢«åˆ¤å®šä¸ºè¿™ç±»é‚£æˆ‘ä»¬å°±å¯¹è¿™ä¸ªäº¤æ˜“è¿›è¡Œæ‹¦æˆªï¼Œ


å®é™…è¿ç”¨ä¼šç¨å¾®å¤æ‚ä¸€ä¸‹ï¼Œä¸‹é¢ä¼šä¸€ä¸€è¯´æ˜å¯¹é©¬å°”ç§‘å¤«é“¾åŠéšå½¢é©¬å°”ç§‘å¤«é“¾çš„ç†è§£æ¨èé˜…è¯»â€˜æ•°å­¦ä¹‹ç¾â€™è¿™ä¹¦å†™çš„çœŸä¸é”™ï¼Œå¾ˆå¤šçŸ¥è¯†ç‚¹æ¯”å¦‚ç†µçš„æ¦‚å¿µç­‰æˆ‘ä»è¿™æœ¬ä¹¦ä¸Šçœ‹åˆ°çš„è§£é‡Šæœ€ä»¤æˆ‘ä¿¡æœè€Œä¸”é€šä¿—

å¦‚ä¸‹æ‰€ç¤ºï¼Œé»˜è®¤åˆ†ç±»ä»40-85ï¼Œé€‰æ‹©é˜€å€¼å¤§ä¸65%çš„å¤±è´¥ç±»åˆ«ï¼Œ
å„ä¸ªè½´åƒä»£è¡¨
* lcs: compoent_ind ä¸­æ ·æœ¬æ€»æ•°
* lrs: compoent_ind ä¸­æ ·æœ¬lossæ¯”ä¾‹
* lps: compoent_ind ä¸­æ ·æœ¬profit sum
* lms: compoent_ind ä¸­æ ·æœ¬profit mean


    train_ump.gmm_component_filter()
      

![output_10_0.png](http://upload-images.jianshu.io/upload_images/3136804-0a19827e0f28fa56.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


![output_10_1.png](http://upload-images.jianshu.io/upload_images/3136804-2499b482a222ddbd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

___

**ç”±äºç®€ä¹¦ä¸æ”¯æŒhtmlè¡¨æ ¼ï¼Œæ‰€ä»¥å®Œæ•´è¡¨æ ¼è¯·æŸ¥è¯¢gitä¸Šipython notebookå®Œæ•´ç‰ˆæœ¬**
___
![Snip20161020_28.png](http://upload-images.jianshu.io/upload_images/3136804-61971f45c27fee2d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


    train_ump.cprs.loc[train_ump.cprs.lrs.argmax()]
		# out
		lcs    49.000000
		lrs     0.755102
		lps    -4.565771
		lms    -0.093179
		Name: 70_66, dtype: float64

ä¸Šé¢æ‰¾å‡ºå¤±è´¥ç‡æœ€é«˜çš„åˆ†ç±»70_66ï¼Œ75ï¼…ä»¥ä¸Šçš„äº¤æ˜“éƒ½æ˜¯å¤±è´¥çš„äº¤æ˜“

ä¸‹é¢éšä¾¿æ‰¾ä¸ªåˆ†ç±»å¯è§†åŒ–ä¸€ä¸‹ï¼Œä½ æœ€ç»ˆæ‰¾å‡ºæ¥çš„åˆ†ç±»å°±æ˜¯ç±»ä¼¼è¿™ä¸ªçš„ç¬¬8åˆ†ç±»è¿˜æœ‰ç¬¬29åˆ†ç±»


![output_14_0.png](http://upload-images.jianshu.io/upload_images/3136804-ef2e636d9c325f3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**å¯»æ‰¾å…¨å±€æœ€ä¼˜**

	# æ‘˜å½•éƒ¨ä»½ä»£ç ï¼Œå…·ä½“è¯·æŸ¥é˜…UmpBase.py

	def brust_min(self):
	    """
	    å…¨å±€æœ€ä¼˜
	    :return:
	    """
	    cprs = self.cprs
	    optv = sco.brute(self.min_func_improved, ((round(cprs['lps'].min(), 2), 0, 0.5), (round(cprs['lms'].min(), 2),
	                                                                                      round(cprs['lms'].max(), 3),
	                                                                                      0.01),
	                                              (round(cprs['lrs'].min(), 2), round(cprs['lrs'].max(), 2), 0.1)),
	                     finish=None)
	    return optv

	def sco_min(self, guess):
	    """
	    å±€éƒ¨æœ€ä¼˜å€Ÿ
	    :param guess:
	    :return:
	    """
	    cprs = self.cprs
	    bnds = ((round(cprs['lps'].min(), 3), round(cprs['lps'].max(), 3)),
	            (round(cprs['lms'].min(), 3), round(cprs['lms'].max(), 3)),
	            (round(cprs['lrs'].min(), 3), round(cprs['lrs'].max(), 3)))

	    optv = sco.minimize(self.min_func_improved, guess, method='BFGS',
	                        bounds=bnds)
	    return optv

	def min_func(self, lpmr):
	    cprs = self.cprs
	    nts = self.nts

	    llps = cprs[(cprs['lps'] <= lpmr[0]) & (cprs['lms'] <= lpmr[1]) & (cprs['lrs'] >= lpmr[2])]

	    nts_pd = pd.DataFrame()
	    for nk in llps.index:
	        nts_pd = nts_pd.append(nts[nk])
	    if nts_pd.empty:
	        return np.array([0.0001, 0])
	    nts_pd = nts_pd.drop_duplicates(subset='ind', keep='last')

	    num = nts_pd.shape[0]
	    loss_rate = nts_pd.result.value_counts()[0] / nts_pd.result.value_counts().sum()
	    win_rate = nts_pd.result.value_counts()[1] / nts_pd.result.value_counts().sum()
	    improved = (nts_pd.shape[0] / self.fiter.order_has_ret.shape[0]) * (loss_rate - win_rate)
	    # print improved
	    return np.array([improved, num])

	def min_func_improved(self, lpmr):
	    """
	        æ±‚æœ€å¤§æé«˜ï¼Œminè´Ÿæ•°
	    """
	    return -self.min_func(lpmr)[0]

_____

    train_ump.brust_min()
        # out
        array([-0.48,  0.  ,  0.65])

å°†å…¨å±€ç»“æœ-0.48,  0. 0.65å¸¦å…¥sco_minæ±‚å±€éƒ¨ä¼˜åŒ–

    guess = [-0.63,  0.  ,  0.65]
    train_ump.sco_min(guess)
        # out
		      fun: -0.012936482367227579
		 hess_inv: array([[1, 0, 0],
		       [0, 1, 0],
		       [0, 0, 1]])
		      jac: array([ 0.,  0.,  0.])
		  message: 'Optimization terminated successfully.'
		     nfev: 5
		      nit: 0
		     njev: 1
		   status: 0
		  success: True
		        x: array([-0.63,  0.  ,  0.65])


### ä¸Šé¢æ‰€æœ‰é€‰æ‹©æœ€ä¼˜çš„ç›®çš„å°±æ˜¯ç­›é€‰èƒ½è¾¾åˆ°æœ€ä¼˜åŒ–çš„ç±»åˆ«å­é›†ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæ¯”å¦‚æŸä¸ªåˆ†ç±»è™½ç„¶65%ä»¥ä¸Šçš„å•å­éƒ½æ˜¯å¤±è´¥çš„ï¼Œä½†æ˜¯é‚£35%ç›ˆåˆ©çš„å•å­æ”¶ç›Šå·¨å¤§ï¼Œå¾ˆå¯èƒ½å‡ºç°è¿™ç§æƒ…å†µåœ¨ä½ ä½¿ç”¨é«˜é£é™©å› å­çš„æ—¶å€™ï¼Œæ‰€ä»¥è§£æœ€ä¼˜æ–¹ç¨‹ç»„ä½¿ç”¨å‡¸ä¼˜åŒ–æŠ€æœ¯é€‰å–æœ€ä¼˜å­é›†
____

### ç­›é€‰å‡ºç¬¦åˆæœ€ä¼˜çš„llps

    llps = train_ump.cprs[(train_ump.cprs['lps'] <= -0.63) & (train_ump.cprs['lms'] <= -0.00 )& (train_ump.cprs['lrs'] >=0.65)]
    llps
        
**ç”±äºç®€ä¹¦ä¸æ”¯æŒhtmlè¡¨æ ¼ï¼Œæ‰€ä»¥å®Œæ•´è¡¨æ ¼è¯·æŸ¥è¯¢gitä¸Šipython notebookå®Œæ•´ç‰ˆæœ¬**
___

![Snip20161021_29.png](http://upload-images.jianshu.io/upload_images/3136804-832c05307938ece0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



	# é’ˆå¯¹å­é›†llpsçš„å¯¹ä¹‹å‰äº¤æ˜“çš„è´Ÿä½œç”¨åŠ›çš„ç»Ÿè®¡
	def choose_cprs_component(self, llps):
	    """
	    :param llps: cprs[(so.cprs['lps'] < 0) & (so.cprs['lms'] < -0.0)]
	    ä½ æ‰€éœ€è¦çš„ç¬¦åˆç­›é€‰æ¡ä»¶çš„cprs
	    :return:
	    """
	    if not hasattr(self, 'cprs'):
	        raise ValueError('gmm_component_filter not exe!!!! ')

	    nts_pd = pd.DataFrame()
	    for nk in llps.index:
	        nts_pd = nts_pd.append(self.nts[nk])
	    nts_pd = nts_pd.drop_duplicates(subset='ind', keep='last')
	    ZLog.info('nts_pd.shape = {0}'.format(nts_pd.shape))
	    loss_rate = nts_pd.result.value_counts()[0] / nts_pd.result.value_counts().sum()
	    win_rate = nts_pd.result.value_counts()[1] / nts_pd.result.value_counts().sum()
	    ZLog.info('nts_pd loss rate = {0}'.format(loss_rate))

	    improved = (nts_pd.shape[0] / self.fiter.order_has_ret.shape[0]) * (loss_rate - win_rate)
	    ZLog.info('improved rate = {0}'.format(improved))

	    xt = self.fiter.order_has_ret.result.value_counts()
	    ZLog.info('predict win rate = ' + str(xt[1] / xt.sum() + improved))

	    nts_pd.sort_index()['profit'].cumsum().plot()
	    plt.show()

å¦‚ä¸‹æ˜¾ç°è¿™äº›é€‰å–çš„å­é›†llpsçš„å¯¹ä¹‹å‰äº¤æ˜“çš„è´Ÿä½œç”¨åŠ›

1. loss_rateç¨å°ç›¸å¯¹é˜€å€¼0.65ã€‚
2. é¢„æœŸèƒœç‡æå‡0.0129

    train_ump.choose_cprs_component(llps)
		ï¼ƒ out
		nts_pd.shape = (1920, 9)
		nts_pd loss rate = 0.6359375
		improved rate = 0.0129364823672
		predict win rate = 0.513618002032


![output_24_1.png](http://upload-images.jianshu.io/upload_images/3136804-9c1b78b5593207bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


å¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºçœ‹çœ‹è¿™ä¸ª61_50æœ‰72%å¤±è´¥çš„åˆ†ç±»åˆ—ï¼Œ**å‘ç°å†…åœ¨çš„éšå«æ„ä¹‰**


deg_windowPdï¼Œ deg_60WindowPdéƒ½æ˜¯åœ¨ï¼5ï¼ï¼11çš„è´Ÿæ•°ï¼Œwave_score1ä¼šåœ¨1.5-2ï¼Œ deg_hisWindowPdæ²¡æœ‰æ˜æ˜¾è§„å¾‹ï¼Œçœ‹åˆ°äº†å—ï¼Œæˆ‘ä»¬èƒ½ä»gmmï¼hmmçš„åˆ†ç±»ä¸­å‘ç°æˆ‘ä»¬èƒ½ç†è§£çš„è§„å¾‹ï¼Œè¿™å°±ä¿è¯äº†æˆ‘ä»¬çš„äº¤æ˜“ä¿¡å¿ƒï¼Œå¯¹æ¯”é»‘ç›’çš„æ·±åº¦å­¦ä¹ æ–¹å¼ï¼Œä¼˜ç‚¹ä¸€ç›®äº†ç„¶

![Snip20161021_30.png](http://upload-images.jianshu.io/upload_images/3136804-59c1942dd4f911fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

___

**å¦‚ä¸‹æ‰€ç¤ºæµ‹è¯•é›†æ²¡æœ‰å¼€å¯å› å­ä¼˜åŒ–çš„ç»“æœ0.497ï¼Œæ¨¡å‹é¢„æµ‹èƒ½æé«˜0.0129 æ ¹æ®æ•°æ®æ˜¾ç¤ºå¯ä»¥ä¼˜åŒ–åˆ°0.509å—ï¼Ÿ**

    test_ump = UmpMainClass(orders_pd_test, MlFiterGoldenPdClass)
    test_ump.show_general()
		ï¼ƒ out
		all fit order = (4588, 31)
		win rate = 0.497820401046
		profit_cg.sum() = 23.8727798282
		win mean = 0.0724627453005 loss_mean = -0.0615429338615 


![output_28_1.png](http://upload-images.jianshu.io/upload_images/3136804-1c648f551ddb7685.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**å°†æ•´ä¸ªä¼˜åŒ–å¥½çš„æ¨¡å‹åºåˆ—è¯åˆ°æœ¬åœ°**

    train_ump.dump_clf(llps)

ä½¿ç”¨åˆ‡å‰²æµ‹è¯•é›†å¼€å¯å› å­ä¼˜åŒ–å›æµ‹ä¼˜åŒ–ï¼š

* use_last_test=True
* BuyGoldenFactor.g_enable_fiter = True    


	# BuyGoldenFactor.g_enable_fiter æŒ‡æ˜ä½¿ç”¨ä¼˜åŒ–åˆ†ç±»å™¨ï¼Œå¯¹åˆ¤æ–­å¤±è´¥æ¦‚ç‡å¤§çš„äº¤æ˜“è¿›è¡Œæ‹¦æˆª
	import BuyGoldenFactor
	from BuyGoldenFactor import BuyGoldenFactorClass
	import MetricsManger
	from MetricsManger import metrics_rsc
	from FactorMetrics import METRICSTYPE

	BuyGoldenFactor.g_enable_fiter = True
	buy_factors = [{'XD': 42, 'class': BuyGoldenFactorClass, 'draw': True}]
	out, orders_pd_test_enable_fiter = MetricsManger.make_metrics_rsc_mul_symbol_grid(buy_factors, n_folds=6, 
	    score_type=METRICSTYPE.SYSMBOL_R_SCORES_GOLDEN.value, ret_cnt_need=0, train_test_split=False, 
	    use_last_test=True, force_one_process=False)

____

	test_filter_ump = UmpMainClass(orders_pd_test_enable_fiter, MlFiterGoldenPdClass)
	test_filter_ump.show_general()
		# out
		all fit order = (4335, 31)
		win rate = 0.504498269896
		profit_cg.sum() = 26.3090428828
		win mean = 0.0691880572237 loss_mean = -0.0582673178493 



![output_34_1.png](http://upload-images.jianshu.io/upload_images/3136804-f09c13c8fe452599.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### å¦‚ä¸Šæ‰€ç¤ºï¼š4588 ï¼ 4335å¤§æ¦‚250ä¸ªäº¤æ˜“è¢«ç»„ç»‡æ‹¦æˆª(å®é™…ä¼šæ›´å¤šï¼Œall fit orderåªæ˜¾ç¤ºåœ¨æˆªæ­¢æ—¶é—´å·²ç»æˆäº¤çš„è‚¡ç¥¨)

### èƒœç‡ä¼˜åŒ–ï¼š0.5044 ï¼ 0.4978 ä¸åˆ°1ä¸ªç‚¹ï¼Œæ¯”é¢„æœŸè¦ä½

### æ”¶ç›Šæ¯”å€¼æå‡æŒºå¤šï¼š26.3 - 23.8

___
æˆ‘ä»¬ç›´è§‚çš„çœ‹çœ‹éƒ½æœ‰å“ªäº›äº¤æ˜“è¢«é˜»æ‹¦äº†

	import TradeProxy
	unsame_order = TradeProxy.find_unsame_in_2orders(orders_pd_test, orders_pd_test_enable_fiter)
	unsame_order = unsame_order[unsame_order.result <> 0]
	unsame_order.shape
		# out
		(253, 32)

å¦‚ä¸‹æ‰€ç¤ºä¹‹å‰é¢„æµ‹å¤±è´¥ç‡0.635ï¼Œå®é™…ç­›å‡ºæ¥çš„å¤±è´¥ç‡æ˜¯0.616 è¿˜ä¸é”™

	pd.options.display.max_columns = 100
	unsame_order.sort_values('buy Date').profit_cg.cumsum().plot()

	xt = unsame_order.result.value_counts()
	ZLog.info('unsame_order loss rate = ' + str(float(xt[-1]) / xt.sum()))
		ï¼ƒ out
		unsame_order loss rate = 0.616600790514


![output_41_1.png](http://upload-images.jianshu.io/upload_images/3136804-bfc951e8bd82317f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**å¦‚ä¸‹å›¾æ‰€ç¤ºçœ‹ä¸‹æœ‰å¾ˆå¤šæ”¶ç›Šè¶…è¿‡20%çš„å•å­è¢«blockæ‰äº†ï¼Œè™½ç„¶ä¹Ÿæœ‰å¾ˆå¤šæŸå¤±è¶…è¿‡20%çš„å•å­**
è§£å†³æ–¹æ¡ˆï¼šgmmåˆ†ç±»ä¸­æ‰¾æŸå¤±è¶…è¿‡å¤šå°‘é˜€å€¼çš„ç±»ä¼¼ä¼˜å…ˆç­›é€‰æˆ–è€…ç»„åˆæƒé‡ç­›é€‰ ä¹‹åç« èŠ‚ä¼šå¼•å…¥è¾¹è£æœºåˆ¶è§£å†³è¿™ä¸ªé—®é¢˜

	import MarketDrawer
	# æ˜¾ç¤ºä¸‰ä¸ªè¢«æ‹¦æˆªäº†çš„æ”¶ç›Šå¤§äº20%çš„å•å­
	MarketDrawer.plot_candle_from_order(unsame_order[unsame_order.profit_cg > 0.20][:3])



![output_44_0.png](http://upload-images.jianshu.io/upload_images/3136804-d86fdcb8d4ce2339.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![output_44_1.png](http://upload-images.jianshu.io/upload_images/3136804-76c64c91f31b0ee9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![output_44_2.png](http://upload-images.jianshu.io/upload_images/3136804-3f35844e17645228.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

	# æ˜¾ç¤º2ä¸ªè¢«æ‹¦æˆªäº†çš„æŸå¤±å¤§äº20%çš„å•å­
	MarketDrawer.plot_candle_from_order(unsame_order[unsame_order.profit_cg < -0.20][:2])


![output_45_0.png](http://upload-images.jianshu.io/upload_images/3136804-252836ea7df4f0e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



![output_45_1.png](http://upload-images.jianshu.io/upload_images/3136804-a7c60896e95486b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


## ä½¿ç”¨ipython notebookçš„äº¤äº’å¼å¯»æ‰¾æ˜¯å¦æé«˜åŸå§‹rateå°±èƒ½å¾—åˆ°æ›´é«˜çš„impove

	lps_range = (round(train_ump.cprs['lps'].min(), 2), round(train_ump.cprs['lps'].max(), 2), 0.1)
	lms_range = (round(train_ump.cprs['lms'].min(), 2), round(train_ump.cprs['lms'].max(), 2), 0.01)
	lrs_range = (round(train_ump.cprs['lrs'].min(), 2), round(train_ump.cprs['lrs'].max(), 2), 0.01)
	def interact_llps(lps, lms, lrs):
	    it_llps = train_ump.cprs[(train_ump.cprs['lps'] <= lps) & (train_ump.cprs['lms'] <= lms)& (train_ump.cprs['lrs'] >=lrs)]
	    if not it_llps.empty:
	        train_ump.choose_cprs_component(it_llps)
	from ipywidgets import interact
	interact(interact_llps, lps=lps_range, lms=lms_range, lrs=lrs_range)


**å®Œæ•´å¯äº¤äº’è¯·å‚é˜…gitä¸Šå®Œæ•´ç‰ˆæœ¬**


![Snip20161021_33.png](http://upload-images.jianshu.io/upload_images/3136804-65b30f28f5abf74e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


**ä½¿ç”¨è§†è§‰ä¸Šæ„Ÿè§‰æ›´å¥½çš„è¿›è¡Œå›æµ‹**

	llps = train_ump.cprs[(train_ump.cprs['lps'] <= -0.63) & (train_ump.cprs['lms'] <= -0.00 )& (train_ump.cprs['lrs'] >=0.68)]
	train_ump.dump_clf(llps)
	BuyGoldenFactor.g_enable_fiter = True
	buy_factors = [{'XD': 42, 'class': BuyGoldenFactorClass, 'draw': True}]
	out, orders_pd_test_enable_fiter2 = MetricsManger.make_metrics_rsc_mul_symbol_grid(buy_factors, n_folds=6, 
	    score_type=METRICSTYPE.SYSMBOL_R_SCORES_GOLDEN.value, ret_cnt_need=0, train_test_split=False, 
	    use_last_test=True, force_one_process=False)

**å¦‚ä¸‹æ‰€ç¤ºç»“æœè¿˜æ²¡ä¹‹å‰çš„å¥½å‘€ï¼Œçœ‹æ¥å¯ä»¥æ¯”è¾ƒç›¸ä¿¡å‡¸ä¼˜åŒ–é€‰æ‹©çš„æœ€ä¼˜å‚æ•°**

	UmpMainClass(orders_pd_test_enable_fiter2, MlFiterGoldenPdClass).show_general()
		ï¼ƒ out
		all fit order = (4477, 31)
		win rate = 0.50033504579
		profit_cg.sum() = 25.0138982168
		win mean = 0.0712054456398 loss_mean = -0.0601899144826 


![output_52_1.png](http://upload-images.jianshu.io/upload_images/3136804-03faee644965b705.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


### ä¿®æ”¹æ‹¦æˆªè§„åˆ™è¯•è¯•ï¼Œå¦‚ä¸‹å¯è§†åŒ–æ‰¾åˆ°0ï¼Œ 0ï¼Œ 0.65æœ‰2215ä¸ª ä¿®æ”¹éœ€è¦å‘½ä¸­åˆ†ç±»åˆ—çš„æ•°é‡ï¼Œ BuyGoldenFactor.g_fiter_ind_cnt = 3 çœ‹çœ‹æ•ˆæœï¼Œç®€å•è¯´å°±æ˜¯æ‰¾ä¸€ä¸ªæ¯”è¾ƒå®½æ¾çš„é™åˆ¶æ¡ä»¶ï¼Œä½†æ˜¯ç±»åˆ«ä»¥å‰å‘½ä¸­ä¸€ä¸ªå°±æ‹¦æˆªäº†ï¼Œç°åœ¨è¦å‘½ä¸­ä¸‰æ¬¡ï¼Œä½ å¯ä»¥å˜åŒ–å‡ºæ— æ•°ä¸ªå˜ç§åœ¨å…·ä½“åº”ç”¨ä¸Šï¼Œè¿™é‡Œåªæ˜¯æä¾›åŸºç¡€æ€è·¯

	llps = train_ump.cprs[(train_ump.cprs['lps'] <= 0) & (train_ump.cprs['lms'] <= 0 )& (train_ump.cprs['lrs'] >=0.65)]
	train_ump.dump_clf(llps)
	BuyGoldenFactor.g_enable_fiter = True
	BuyGoldenFactor.g_fiter_ind_cnt = 3
	buy_factors = [{'XD': 42, 'class': BuyGoldenFactorClass, 'draw': True}]
	out, orders_pd_test_enable_fiter_ = MetricsManger.make_metrics_rsc_mul_symbol_grid(buy_factors, n_folds=6, 
	    score_type=METRICSTYPE.SYSMBOL_R_SCORES_GOLDEN.value, ret_cnt_need=0, train_test_split=False, 
	    use_last_test=True, force_one_process=False)


### æ€ä¹ˆæ ·ï¼Œ çœ‹æ‡‚äº†å—ï¼Ÿæˆ‘è¡·å¿ƒçš„å¸Œæœ›ä½ èƒ½çœ‹æ‡‚æœ¬ç« çš„æ‰€æœ‰å†…å®¹ï¼Œè¿™ç« æ˜¯å…³äºè¿™ç§æ–¹å¼çš„ä¸€ä¸ªå¼€å§‹ï¼Œæœ¬ç« å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸‹ä¸€ç« ç»§ç»­æ·±å…¥ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œæå‡è¯†åˆ«æ•ˆç‡ï¼Œæå‡èƒœç‡ï¼Œè¿™ä¸€ç« èŠ‚å¾ˆé‡è¦ï¼Œæ•´ç¯‡æ–‡ç« æœ€é‡è¦çš„éƒ¨åˆ†åœ¨æˆ‘çœ‹æ¥å°±æ˜¯è¿™ä¸€ç« ï¼

###  å†æ¬¡å¼ºè°ƒæ–‡ç« ä¸­å¿ƒæ€æƒ³ï¼šâ€˜éå‡è¡¡èƒœè´Ÿæ”¶ç›Šâ€™å¸¦æ¥çš„å¿…ç„¶â€™éå‡è¡¡èƒœè´Ÿæ¯”ä¾‹â€˜ï¼Œç›®æ ‡ç”±â€™å› å­â€˜çš„èƒ½åŠ›è§£å†³ä¸€éƒ¨åˆ†ï¼Œâ€™æ¨¡å¼è¯†åˆ«â€˜æå‡å…³é”®çš„ä¸€éƒ¨åˆ†

____

## æ„Ÿè°¢ğŸ™æ‚¨èƒ½æœ‰è€å¿ƒçœ‹åˆ°è¿™é‡Œ
## å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥åŠ é˜¿å¸ƒçš„å¾®ä¿¡ 
## å¾®ä¿¡å·ï¼šaaaabbbuu


![mmexport1475383814280.jpg](http://upload-images.jianshu.io/upload_images/3136804-260ad1a188d413a9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



